# Triggering a fresh run with fixed syntax
name: WhatsApp AI Bot

on:
  push:
    branches: [ master ]
  schedule:
    # Runs only during the day (6 AM and 12 PM UTC)
    - cron: '0 6,12 * * *'
  workflow_dispatch: # Allows manual start

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Crucial for saving session.zip
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Puppeteer Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgbm-dev \
            libnss3 \
            libatk-bridge2.0-0 \
            libgtk-3-0 \
            libasound2t64 \
            libxss1 \
            libxtst6 \
            xvfb \
            unzip \
            zip
          npm install

      - name: Restore Session
        env:
          SESSION_PASSWORD: ${{ secrets.SESSION_PASSWORD }}
        run: |
          if [ -f "session.zip" ]; then
            echo "Attempting to restore session..."
            # Try unzipping with password first, then without. 
            # We ignore exit code 1 because Windows-created zips often cause 'backslash' warnings.
            if [ -n "$SESSION_PASSWORD" ]; then
              unzip -P "$SESSION_PASSWORD" -o session.zip || [ $? -eq 1 ]
            else
              unzip -o session.zip || [ $? -eq 1 ]
            fi
            echo "Session restore completed (checked for warnings)."
          else
            echo "No session zip found. Starting fresh."
          fi

      - name: Run Bot
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          REPLY_ALL: ${{ secrets.REPLY_ALL }}
          OWNER_NUMBER: ${{ secrets.OWNER_NUMBER }}
          EXCLUDED_NUMBERS: ${{ secrets.EXCLUDED_NUMBERS }}
          PERSONA_PROMPT: ${{ secrets.PERSONA_PROMPT }}
          AI_SIGNATURE: ${{ secrets.AI_SIGNATURE }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
        run: |
          # Use xvfb-run for virtual display
          xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" timeout 6h node index.js || echo "Bot timed out or crashed."

      - name: Save Session
        if: always()
        env:
          SESSION_PASSWORD: ${{ secrets.SESSION_PASSWORD }}
        run: |
          # Ensure any remaining node/chrome processes are killed before zipping
          pkill -f node || true
          pkill -f chrome || true
          
          # Zip with password only if it exists
          # We ignore exit code 18 (some files unreadable) as it often happens with LOCK files
          if [ -n "$SESSION_PASSWORD" ]; then
            zip -P "$SESSION_PASSWORD" -r session.zip .wwebjs_auth .wwebjs_cache || [ $? -eq 18 ]
          else
            zip -r session.zip .wwebjs_auth .wwebjs_cache || [ $? -eq 18 ]
          fi
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add session.zip
          git commit -m "Update WhatsApp session (Encrypted)" || echo "No changes to session"
          git push
