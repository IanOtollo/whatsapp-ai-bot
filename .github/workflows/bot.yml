name: WhatsApp AI Bot

on:
  schedule:
    # Runs every 6 hours from 6 AM to 10 PM UTC
    - cron: '0 6,12,18 * * *'
  workflow_dispatch: # Allows manual start

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Crucial for saving session.zip
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Puppeteer Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgbm-dev \
            libnss3 \
            libatk-bridge2.0-0 \
            libgtk-3-0 \
            libasound2 \
            libxss1 \
            libxtst6 \
            xvfb \
            unzip \
            zip
          npm install

      - name: Restore Session
        run: |
          if [ -f "session.zip" ]; then
            unzip session.zip
            echo "Session restored."
          else
            echo "No session zip found. Starting fresh."
          fi

      - name: Run Bot
        env:
          GEMINI_API_KEY: ${{ AIzaSyADTUgLL9f71yJXtfr8JLp0S4ansO2KvHM }}
          REPLY_ALL: ${{ false }}
          OWNER_NUMBER: ${{ 254112993859,254700399641 }}
          EXCLUDED_NUMBERS: ${{ 254722975410,254700458960,254758333996,254725337920 }}
          PERSONA_PROMPT: ${{ You are Ian's intelligent AI assistant. You are highly sophisticated, smart, articulate, and helpful. You maintain a professional yet warm tone. You should sound like a high-level executive assistant who knows Ian's style perfectly. }}
          AI_SIGNATURE: ${{ âœ¦ [Automated Response: Ian's AI Assistant] }}
        run: |
          # Run for 6 hours (max limit) or until it crashes
          timeout 6h node index.js || echo "Bot timed out or crashed."

      - name: Save Session
        if: always()
        run: |
          zip -r session.zip .wwebjs_auth .wwebjs_cache || true
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add session.zip
          git commit -m "Update WhatsApp session" || echo "No changes to session"
          git push
